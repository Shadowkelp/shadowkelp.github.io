<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sufjan Song Rankings</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .song-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
            cursor: pointer;
        }
        #results, #progress, #save-load {
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Sufjan Song Ranker</h1>
    <div id="comparison">
        <h2>Which song do you prefer?</h2>
        <button id="song1" class="song-button"></button>
        <button id="song2" class="song-button"></button>
    </div>
    <div id="progress"></div>
    <div id="save-load">
        <button id="save">Save Progress</button>
        <button id="load">Load Progress</button>
    </div>
    <div id="results" class="hidden">
        <h2>Final Rankings</h2>
        <ol id="rankings"></ol>
        <button id="restart">Start Over</button>
    </div>

    <script>
        const songs = [
    { album: "Call Me By Your Name", title: "Mystery of Love" },
    { album: "Call Me By Your Name", title: "Visions of Gideon" },
    { album: "Call Me By Your Name", title: "Futile Devices (Doveman Remix)" },

    { album: "A Sun Came", title: "We Are What You Say" },
    { album: "A Sun Came", title: "A Winner Needs a Wand" },
    { album: "A Sun Came", title: "Rake" },
    { album: "A Sun Came", title: "Siamese Twins" },
    { album: "A Sun Came", title: "Demetrius" },
    { album: "A Sun Came", title: "Dumb I Sound" },
    { album: "A Sun Came", title: "Wordsworth's Ridge (for Fran Fike)" },
    { album: "A Sun Came", title: "Belly Button" },
    { album: "A Sun Came", title: "Rice Pudding" },
    { album: "A Sun Came", title: "A Loverless Bed (Without Remission)" },
    { album: "A Sun Came", title: "Godzuki" },
    { album: "A Sun Came", title: "Super Sexy Woman" },
    { album: "A Sun Came", title: "The Oracle Said Wander" },
    { album: "A Sun Came", title: "Happy Birthday" },
    { album: "A Sun Came", title: "Jason" },
    { album: "A Sun Came", title: "Kill" },
    { album: "A Sun Came", title: "Ya Leil" },
    { album: "A Sun Came", title: "A Sun Came" },
    { album: "A Sun Came", title: "Satan's Saxophones" },

    { album: "Enjoy Your Rabbit", title: "Year Of The Astmatic Cat" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Monkey" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Rat" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Ox" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Boar" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Tiger" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Snake" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Sheep" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Rooster" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Dragon" },
    { album: "Enjoy Your Rabbit", title: "Enjoy Your Rabbit" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Dog" },
    { album: "Enjoy Your Rabbit", title: "Year Of The Horse" },
    { album: "Enjoy Your Rabbit", title: "Year Of Our Lord" },

    { album: "Michigan", title: "Flint (For the Unemployed and Underpaid)" },
    { album: "Michigan", title: "All Good Naysayers, Speak Up! Or Forever Hold Your Peace!" },
    { album: "Michigan", title: "For the Widows in Paradise, for the Fatherless in Ypsilanti" },
    { album: "Michigan", title: "Say Yes! to M!ch!gan!" },
    { album: "Michigan", title: "The Upper Peninsula" },
    { album: "Michigan", title: "Tahquamenon Falls" },
    { album: "Michigan", title: "Holland" },
    { album: "Michigan", title: "Detroit, Lift Up Your Weary Head! (Rebuild! Restore! Reconsider!)" },
    { album: "Michigan", title: "Romulus" },
    { album: "Michigan", title: "Alanson, Crooked River" },
    { album: "Michigan", title: "Sleeping Bear, Sault Saint Marie" },
    { album: "Michigan", title: "They Also Mourn Who Do Not Wear Black (For the Homeless in Muskegon)" },
    { album: "Michigan", title: "Oh God, Where Are You Now? (In Pickeral Lake? Pigeon? Marquette? ...)" },
    { album: "Michigan", title: "Redford (For Yia-Yia & Pappou)" },
    { album: "Michigan", title: "Vito's Ordination Song" },

    { album: "Seven Swans", title: "All the Trees of the Field Will Clap Their Hands" },
    { album: "Seven Swans", title: "The Dress Looks Nice on You" },
    { album: "Seven Swans", title: "In the Devils Territory" },
    { album: "Seven Swans", title: "To Be Alone with You" },
    { album: "Seven Swans", title: "Abraham" },
    { album: "Seven Swans", title: "Sister" },
    { album: "Seven Swans", title: "Size Too Small" },
    { album: "Seven Swans", title: "We Won't Need Legs to Stand" },
    { album: "Seven Swans", title: "A Good Man Is Hard to Find" },
    { album: "Seven Swans", title: "He Woke Me Up Again" },
    { album: "Seven Swans", title: "Seven Swans" },
    { album: "Seven Swans", title: "The Transfiguration" },

    { album: "Illinois", title: "Concerning the UFO Sighting Near Highland, Illinois" },
    { album: "Illinois", title: "The Black Hawk War, Or, How to Demolish an Entire Civilization and Still Feel Good About Yourself in the Morning, or, We Apologize for the Inconvenience but You're Going to Have to Leave Now, or, 'I Have Fought the Big Knives and Will Continue to Fight Them Until They Are Off Our Lands!'" },
    { album: "Illinois", title: "Come on! Feel the Illinoise! Part I: The World's Columbian Exposition Part II: Carl Sandburg Visits Me in a Dream" },
    { album: "Illinois", title: "John Wayne Gacy, Jr." },
    { album: "Illinois", title: "Jacksonville" },
    { album: "Illinois", title: "A Short Reprise for Mary Todd, Who Went Insane, But for Very Good Reasons" },
    { album: "Illinois", title: "Decatur, Or, Round of Applause for Your Stepmother!" },
    { album: "Illinois", title: "One Last 'Whoo-Hoo!' for the Pullman" },
    { album: "Illinois", title: "Chicago" },
    { album: "Illinois", title: "Casimir Pulaski Day" },
    { album: "Illinois", title: "To the Workers of the Rock River Valley Region, I Have an Idea Concerning Your Predicament" },
    { album: "Illinois", title: "The Man of Metropolis Steals Our Hearts" },
    { album: "Illinois", title: "Prairie Fire That Wanders About" },
    { album: "Illinois", title: "A Conjunction of Drones Simulating the Way in Which Sufjan Stevens Has an Existential Crisis in the Great Godfrey Maze" },
    { album: "Illinois", title: "The Predatory Wasp of the Palisades Is out to Get Us!" },
    { album: "Illinois", title: "They Are Night Zombies!! They Are Neighbors!! They Have Come Back from the Dead!! Ahhhh!" },
    { album: "Illinois", title: "Let's Hear That String Part Again, Because I Don't Think They Heard It All the Way Out in Bushnell" },
    { album: "Illinois", title: "In This Temple as in the Hearts of Man for Whom He Saved the Earth" },
    { album: "Illinois", title: "The Seer's Tower" },
    { album: "Illinois", title: "The Tallest Man, the Broadest Shoulders Part I: The Great Frontier Part II: Come to Me Only With Playthings Now" },
    { album: "Illinois", title: "Riffs and Variations on a Single Note for Jelly Roll, Earl Hines, Louis Armstrong, Baby Dodds, and the King of Swing, to Name a Few" },
    { album: "Illinois", title: "Out of Egypt, Into the Great Laugh of Mankind, and I Shake the Dirt from My Sandals as I Run" },

    { album: "The Age of Adz", title: "Futile Devices" },
    { album: "The Age of Adz", title: "Too Much" },
    { album: "The Age of Adz", title: "Age of Adz" },
    { album: "The Age of Adz", title: "I Walked" },
    { album: "The Age of Adz", title: "Now That I'm Older" },
    { album: "The Age of Adz", title: "Get Real Get Right" },
    { album: "The Age of Adz", title: "Bad Communication" },
    { album: "The Age of Adz", title: "Vesuvius" },
    { album: "The Age of Adz", title: "All for Myself" },
    { album: "The Age of Adz", title: "I Want to Be Well" },
    { album: "The Age of Adz", title: "Impossible Soul" },

    { album: "Carrie & Lowell", title: "Death with Dignity" },
    { album: "Carrie & Lowell", title: "Should Have Known Better" },
    { album: "Carrie & Lowell", title: "All of Me Wants All of You" },
    { album: "Carrie & Lowell", title: "Drawn to the Blood" },
    { album: "Carrie & Lowell", title: "Eugene" },
    { album: "Carrie & Lowell", title: "Fourth of July" },
    { album: "Carrie & Lowell", title: "The Only Thing" },
    { album: "Carrie & Lowell", title: "Carrie & Lowell" },
    { album: "Carrie & Lowell", title: "John My Beloved" },
    { album: "Carrie & Lowell", title: "No Shade in the Shadow of the Cross" },
    { album: "Carrie & Lowell", title: "Blue Bucket of Gold" },

    { album: "Ascension", title: "Make Me an Offer I Cannot Refuse" },
    { album: "Ascension", title: "Run Away With Me" },
    { album: "Ascension", title: "Video Game" },
    { album: "Ascension", title: "Lamentations" },
    { album: "Ascension", title: "Tell Me You Love Me" },
    { album: "Ascension", title: "Die Happy" },
    { album: "Ascension", title: "Ativan" },
    { album: "Ascension", title: "Ursa Major" },
    { album: "Ascension", title: "Landslide" },
    { album: "Ascension", title: "Gilgamesh" },
    { album: "Ascension", title: "Death Star" },
    { album: "Ascension", title: "Goodbye to All That" },
    { album: "Ascension", title: "Sugar" },
    { album: "Ascension", title: "The Ascension" },
    { album: "Ascension", title: "America" },

    { album: "Javelin", title: "Goodbye Evergreen" },
    { album: "Javelin", title: "A Running Start" },
    { album: "Javelin", title: "Will Anybody Ever Love Me?" },
    { album: "Javelin", title: "Everything That Rises" },
    { album: "Javelin", title: "Genuflecting Ghost" },
    { album: "Javelin", title: "My Red Little Fox" },
    { album: "Javelin", title: "So You Are Tired" },
    { album: "Javelin", title: "Javelin (To Have and to Hold)" },
    { album: "Javelin", title: "Shit Talk" },
    { album: "Javelin", title: "There's a World" },
    { album: "Javelin", title: "Malthusian Mistress" },
    { album: "Javelin", title: "Is It My Fault?" },
    { album: "Javelin", title: "Fireproof" },
    { album: "Javelin", title: "Old Man of the Lake" },
    { album: "Javelin", title: "The Kiss of Niobe" },

    { album: "The Avalanche", title: "The Avalanche" },
    { album: "The Avalanche", title: "Dear Mr. Supercomputer" },
    { album: "The Avalanche", title: "Adlai Stevenson" },
    { album: "The Avalanche", title: "The Vivian Girls Are Visited in the Night by Saint Dargarius and His Squadron of Benevolent Butterflies" },
    { album: "The Avalanche", title: "Chicago (Acoustic Version)" },
    { album: "The Avalanche", title: "The Henney Buggy Band" },
    { album: "The Avalanche", title: "Saul Bellow" },
    { album: "The Avalanche", title: "Carlyle Lake" },
    { album: "The Avalanche", title: "Springfield, or Bobby Got a Shadfly Caught in His Hair" },
    { album: "The Avalanche", title: "The Mistress Witch from McClure (or, The Mind That Knows Itself)" },
    { album: "The Avalanche", title: "Kaskaskia River" },
    { album: "The Avalanche", title: "Chicago (Adult Contemporary Easy Listening Version)" },
    { album: "The Avalanche", title: "Inaugural Pop Music for Jane Margaret Byrne" },
    { album: "The Avalanche", title: "No Man's Land" },
    { album: "The Avalanche", title: "The Palm Sunday Tornado Hits Crystal Lake" },
    { album: "The Avalanche", title: "The Pick-Up" },
    { album: "The Avalanche", title: "The Perpetual Self, or \"What Would Saul Alinsky Do?\"" },
    { album: "The Avalanche", title: "For Clyde Tombaugh" },
    { album: "The Avalanche", title: "Chicago (Multiple Personality Disorder Version)" },
    { album: "The Avalanche", title: "Pittsfield" },
    { album: "The Avalanche", title: "The Undivided Self (for Eppie and Popo)" },
			
    { album: "The Greatest Gift", title: "Death with Dignity (Helado Negro Remix)" },
    { album: "The Greatest Gift", title: "John My Beloved (iPhone Demo)" },
    { album: "The Greatest Gift", title: "Drawn to the Blood (Fingerpicking Remix)" },
    { album: "The Greatest Gift", title: "The Greatest Gift" },
    { album: "The Greatest Gift", title: "Exploding Whale (Doveman Remix)" },
    { album: "The Greatest Gift", title: "All of Me Wants All of You (Helado Negro Remix)" },
    { album: "The Greatest Gift", title: "Fourth of July (900X Remix)" },
    { album: "The Greatest Gift", title: "The Hidden River of My Life" },
    { album: "The Greatest Gift", title: "City of Roses" },
    { album: "The Greatest Gift", title: "Carrie & Lowell (iPhone Demo)" },

    
    { album: "All Delighted People", title: "All Delighted People (original version)" },
    { album: "All Delighted People", title: "Enchanting Ghost" },
    { album: "All Delighted People", title: "Heirloom" },
    { album: "All Delighted People", title: "From the Mouth of Gabriel" },
    { album: "All Delighted People", title: "The Owl and the Tanager" },
    { album: "All Delighted People", title: "All Delighted People (classic rock version)" },
    { album: "All Delighted People", title: "Arnika" },
    { album: "All Delighted People", title: "Djohariah" }
];

        let songData = [];
        let comparisons = 0;
        const minComparisons = songs.length * 2;
        const maxComparisons = songs.length * 5;
        const convergenceThreshold = 10;
        let lastTopSongs = [];

        function initializeSongData() {
            songData = songs.map(song => ({ 
                ...song, 
                elo: 1400, 
                comparisons: 0, 
                confidence: 0 
            }));
        }

        function calculateElo(winner, loser) {
            const k = 32 * (1 - winner.confidence);
            const expectedScoreWinner = 1 / (1 + Math.pow(10, (loser.elo - winner.elo) / 400));
            const expectedScoreLoser = 1 - expectedScoreWinner;

            winner.elo += k * (1 - expectedScoreWinner);
            loser.elo += k * (0 - expectedScoreLoser);

            winner.comparisons++;
            loser.comparisons++;

            winner.confidence = Math.min(winner.confidence + 0.1, 0.9);
            loser.confidence = Math.min(loser.confidence + 0.1, 0.9);
        }

        function selectSongsForComparison() {
            const leastCompared = _.minBy(songData, 'comparisons');
            if (leastCompared.comparisons < 5) {
                return [leastCompared, _.sample(_.without(songData, leastCompared))];
            }
            return _.sampleSize(songData, 2);
        }

        function displayComparison() {
            const [song1, song2] = selectSongsForComparison();
            document.getElementById('song1').textContent = `${song1.title} (${song1.album})`;
            document.getElementById('song2').textContent = `${song2.title} (${song2.album})`;

            document.getElementById('song1').onclick = () => handleChoice(song1, song2);
            document.getElementById('song2').onclick = () => handleChoice(song2, song1);

            updateProgress();
        }

        function handleChoice(winner, loser) {
            calculateElo(winner, loser);
            comparisons++;

            if (shouldStop()) {
                displayResults();
            } else {
                displayComparison();
            }
        }

        function shouldStop() {
            if (comparisons < minComparisons) return false;
            if (comparisons >= maxComparisons) return true;

            const topSongs = _.orderBy(songData, ['elo'], ['desc']).slice(0, 10);
            const topSongsStable = _.isEqual(
                topSongs.map(s => s.title),
                lastTopSongs.map(s => s.title)
            );

            lastTopSongs = topSongs;

            return topSongsStable && comparisons >= minComparisons + convergenceThreshold;
        }

        function updateProgress() {
            const progressEl = document.getElementById('progress');
            const percentage = Math.min((comparisons / minComparisons) * 100, 100);
            progressEl.textContent = `Progress: ${Math.round(percentage)}%`;
        }

        function displayResults() {
            document.getElementById('comparison').classList.add('hidden');
            document.getElementById('progress').classList.add('hidden');
            document.getElementById('save-load').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');

            const sortedSongs = _.orderBy(songData, ['elo'], ['desc']);
            const rankings = document.getElementById('rankings');
            rankings.innerHTML = sortedSongs.map(song => 
                `<li>${song.title} (${song.album}) - Elo: ${Math.round(song.elo)}</li>`
            ).join('');
        }

        function saveProgress() {
            const saveData = {
                songData: songData,
                comparisons: comparisons,
                lastTopSongs: lastTopSongs
            };
            localStorage.setItem('songComparisonProgress', JSON.stringify(saveData));
            alert('Progress saved successfully!');
        }

        function loadProgress() {
            const savedData = localStorage.getItem('songComparisonProgress');
            if (savedData) {
                const parseData = JSON.parse(savedData);
                songData = parseData.songData;
                comparisons = parseData.comparisons;
                lastTopSongs = parseData.lastTopSongs;
                alert('Progress loaded successfully!');
                displayComparison();
            } else {
                alert('No saved progress found.');
            }
        }

        document.getElementById('restart').onclick = () => {
            initializeSongData();
            comparisons = 0;
            lastTopSongs = [];
            document.getElementById('comparison').classList.remove('hidden');
            document.getElementById('progress').classList.remove('hidden');
            document.getElementById('save-load').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            displayComparison();
        };

        document.getElementById('save').onclick = saveProgress;
        document.getElementById('load').onclick = loadProgress;

        initializeSongData();
        displayComparison();
    </script>
</body>
</html>